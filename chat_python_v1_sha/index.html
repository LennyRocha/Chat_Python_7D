<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Chat Grupal Seguro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        height: 100vh;
        overflow: hidden;
        background: #1a1a2e;
      }

      #container {
        display: flex;
        height: 100vh;
      }

      #usuarios {
        width: 250px;
        background: #16213e;
        color: white;
        padding: 20px;
        overflow-y: auto;
        border-right: 2px solid #0f3460;
      }

      #usuarios h3 {
        margin-bottom: 15px;
        font-size: 18px;
        color: #e94560;
        border-bottom: 2px solid #e94560;
        padding-bottom: 10px;
      }

      #lista-usuarios div {
        padding: 10px;
        margin: 8px 0;
        background: #0f3460;
        border-radius: 8px;
        transition: all 0.3s;
      }

      #lista-usuarios div:hover {
        background: #1a4d7a;
        transform: translateX(5px);
      }

      #lista-usuarios i {
        margin-right: 8px;
        color: #4ecca3;
      }

      #chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #0f3460;
      }

      .the_nav {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        font-size: 24px;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }

      .the_nav input {
        display: none;
      }

      #chat {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #1a1a2e;
      }

      #chat div {
        margin: 10px 0;
        padding: 12px 15px;
        background: #16213e;
        border-radius: 12px;
        word-wrap: break-word;
        animation: fadeIn 0.3s;
        border-left: 3px solid #4ecca3;
        color: #e8e8e8;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      #chat div b {
        color: #4ecca3;
      }

      #input-container {
        display: flex;
        padding: 20px;
        background: #16213e;
        gap: 15px;
        border-top: 2px solid #0f3460;
      }

      #mensaje {
        flex: 1;
        padding: 15px;
        border: 2px solid #4ecca3;
        border-radius: 12px;
        font-size: 15px;
        resize: none;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #0f3460;
        color: white;
        transition: all 0.3s;
      }

      #mensaje:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
      }

      #mensaje::placeholder {
        color: #888;
      }

      #send {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }

      #send:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      }

      #send:active {
        transform: scale(0.95);
      }

      /* Estilo para mensajes del sistema */
      .system-message {
        background: #0f3460 !important;
        border-left: 3px solid #e94560 !important;
        font-style: italic;
      }

      .my-message {
        background: #1a4d7a !important;
        border-left: 3px solid #667eea !important;
      }

      /* Scrollbar personalizado */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #0f3460;
      }

      ::-webkit-scrollbar-thumb {
        background: #4ecca3;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #667eea;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <!-- Columna de usuarios -->
      <div id="usuarios">
        <h3><i class="fas fa-users"></i> Usuarios Online</h3>
        <div id="lista-usuarios"></div>
      </div>

      <!-- Columna de chat -->
      <div id="chat-container">
        <header class="the_nav">
          <i class="fas fa-comments"></i> Chat Seguro (AES-256 + HMAC)
        </header>
        <div id="chat"></div>
        <div id="input-container">
          <textarea
            id="mensaje"
            placeholder="Escribe un mensaje cifrado..."
            rows="1"
          ></textarea>
          <button id="send">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              width="28"
              height="28"
              fill="currentColor"
            >
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <script>
      const nombre = prompt("üë§ Escribe tu nombre:") || "An√≥nimo";

      // CONFIGURACI√ìN DEL SERVIDOR
      // Si el servidor est√° en la misma m√°quina, usa "localhost"
      // Si est√° en otra m√°quina de la red, usa su IP (ej: "192.168.x.x")
      const SERVIDOR_IP = "localhost";
      const SERVIDOR_PUERTO = 5001;
      const ws = new WebSocket(`ws://${SERVIDOR_IP}:${SERVIDOR_PUERTO}`);

      // CLAVES DE CIFRADO - Deben coincidir EXACTAMENTE con el servidor
      const CLAVE_SECRETA = "clave_super_secreta";

      // Crear clave AES de exactamente 32 bytes (256 bits) - m√©todo directo
      const AES_KEY = new Uint8Array([
        49, 50, 51, 52, 53, 54, 55, 56, 57, 48, 49, 50, 51, 52, 53, 54, 55, 56,
        57, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 48, 49, 50,
      ]); // Corresponde a "12345678901234567890123456789012"

      console.log(
        "‚úì Longitud de AES_KEY:",
        AES_KEY.length,
        "bytes =",
        AES_KEY.length * 8,
        "bits"
      );

      // Funci√≥n para cifrar con AES-CBC y generar HMAC
      async function cifrarYGenerarHMAC(texto) {
        const textEncoder = new TextEncoder();

        // Verificar que la clave tenga exactamente 32 bytes
        console.log("‚úì AES_KEY en cifrado:", AES_KEY.length, "bytes");
        console.log(
          "‚úì AES_KEY valores:",
          Array.from(AES_KEY).slice(0, 10),
          "..."
        );

        if (AES_KEY.length !== 32) {
          throw new Error(
            `Clave inv√°lida: tiene ${AES_KEY.length} bytes, necesita 32`
          );
        }

        // Generar IV de 16 bytes para AES-CBC
        const iv = crypto.getRandomValues(new Uint8Array(16));

        // Importar clave AES-256
        const keyAES = await crypto.subtle.importKey(
          "raw",
          AES_KEY,
          { name: "AES-CBC" },
          false,
          ["encrypt"]
        );

        // Aplicar padding PKCS7 manualmente
        const plaintext = textEncoder.encode(texto);
        const blockSize = 16;
        const paddingLen = blockSize - (plaintext.length % blockSize);
        const padded = new Uint8Array(plaintext.length + paddingLen);
        padded.set(plaintext);
        for (let i = plaintext.length; i < padded.length; i++) {
          padded[i] = paddingLen;
        }

        // Cifrar
        const encrypted = await crypto.subtle.encrypt(
          { name: "AES-CBC", iv },
          keyAES,
          padded
        );

        // Combinar IV + ciphertext
        const combined = new Uint8Array(iv.length + encrypted.byteLength);
        combined.set(iv, 0);
        combined.set(new Uint8Array(encrypted), iv.length);

        // Generar HMAC-SHA256
        const keyHMAC = await crypto.subtle.importKey(
          "raw",
          textEncoder.encode(CLAVE_SECRETA),
          { name: "HMAC", hash: "SHA-256" },
          false,
          ["sign"]
        );
        const hmacBuffer = await crypto.subtle.sign("HMAC", keyHMAC, combined);

        // Codificar para enviar (URL-safe base64)
        const cipherB64 = btoa(String.fromCharCode(...combined))
          .replace(/\+/g, "-")
          .replace(/\//g, "_")
          .replace(/=/g, "");

        const hmacHex = Array.from(new Uint8Array(hmacBuffer))
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");

        return `${cipherB64}|${hmacHex}`;
      }

      // Funci√≥n para mostrar mensajes en el chat
      function mostrarMensaje(mensaje, esPropio = false, esSistema = false) {
        const chatDiv = document.getElementById("chat");
        const msgDiv = document.createElement("div");

        if (esSistema) {
          msgDiv.className = "system-message";
        } else if (esPropio) {
          msgDiv.className = "my-message";
        }

        msgDiv.innerHTML = mensaje;
        chatDiv.appendChild(msgDiv);
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }

      // Eventos del WebSocket
      ws.addEventListener("open", () => {
        console.log("‚úì Conectado al servidor WebSocket");
        mostrarMensaje(
          '<i class="fas fa-check-circle"></i> <b>Conectado al servidor</b>',
          false,
          true
        );
      });

      ws.addEventListener("error", (error) => {
        console.error("‚úó Error WebSocket:", error);
        mostrarMensaje(
          '<i class="fas fa-exclamation-triangle"></i> <b>Error de conexi√≥n al servidor</b>',
          false,
          true
        );
      });

      ws.addEventListener("close", () => {
        console.log("‚ö† Desconectado del servidor");
        mostrarMensaje(
          '<i class="fas fa-times-circle"></i> <b>Desconectado del servidor</b>',
          false,
          true
        );
      });

      ws.addEventListener("message", (event) => {
        const data = event.data;

        // Petici√≥n de nombre
        if (data === "NOMBRE") {
          ws.send(nombre);
          return;
        }

        // Actualizar lista de usuarios
        if (data.startsWith("USUARIOS:")) {
          const lista = data
            .replace("USUARIOS:", "")
            .split(",")
            .filter((u) => u.trim());
          const listaDiv = document.getElementById("lista-usuarios");
          listaDiv.innerHTML = lista
            .map((u) => `<div><i class="fas fa-user"></i> ${u}</div>`)
            .join("");
          return;
        }

        // Mostrar mensajes normales
        mostrarMensaje(data);
      });

      // Funci√≥n para enviar mensajes
      async function enviar() {
        const input = document.getElementById("mensaje");
        const mensaje = input.value.trim();

        if (mensaje === "") return;

        if (ws.readyState !== WebSocket.OPEN) {
          alert("‚ö†Ô∏è No est√°s conectado al servidor");
          return;
        }

        try {
          // Mostrar localmente
          mostrarMensaje(`<b>T√∫:</b> ${mensaje}`, true);

          // Cifrar + HMAC
          const paquete = await cifrarYGenerarHMAC(mensaje);
          ws.send(paquete);

          input.value = "";
        } catch (error) {
          console.error("Error al enviar:", error);
          mostrarMensaje(
            `<b>‚ùå Error al cifrar:</b> ${error.message}`,
            false,
            true
          );
        }
      }

      // Event listeners
      document
        .getElementById("mensaje")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            enviar();
          }
        });

      document.getElementById("send").addEventListener("click", enviar);

      // Auto-resize del textarea
      document.getElementById("mensaje").addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = Math.min(this.scrollHeight, 120) + "px";
      });
    </script>
  </body>
</html>
